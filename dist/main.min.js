"use strict";var t=require("sqlite3"),e=require("path"),s=require("fs"),r=require("mongodb"),i=require("crypto"),n=require("buffer"),o=require("fs/promises"),a=require("bcrypt");const c=["volunteer","user","class","class_vol","user_vol","picture","issue","notice","user_notice","class_notice"];function u(t){const e=c.map((e=>new Promise(((s,r)=>{t.all(`SELECT * FROM ${e}`,((t,i)=>{t&&r(t),s({key:e,value:i})}))}))));return Promise.all(e)}async function d(){const r=function(){const s=e.resolve("database","zvms.db");return new t.Database(s)}(),i=e.resolve("data","export");(await u(r)).forEach((t=>{console.log("Exporting table",t.key),s.writeFileSync(e.resolve(i,t.key+".json"),JSON.stringify(t.value,null,2))}))}var l="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function h(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var f,p={exports:{}};
/**
 * [js-md5]{@link https://github.com/emn178/js-md5}
 *
 * @namespace md5
 * @version 0.8.3
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2023
 * @license MIT
 */f=p,function(){var t="input is invalid type",e="object"==typeof window,s=e?window:{};s.JS_MD5_NO_WINDOW&&(e=!1);var r=!e&&"object"==typeof self,o=!s.JS_MD5_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;o?s=l:r&&(s=self);var a,c=!s.JS_MD5_NO_COMMON_JS&&f.exports,u=!s.JS_MD5_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,d="0123456789abcdef".split(""),h=[128,32768,8388608,-2147483648],p=[0,8,16,24],y=["hex","array","digest","buffer","arrayBuffer","base64"],m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),g=[];if(u){var v=new ArrayBuffer(68);a=new Uint8Array(v),g=new Uint32Array(v)}var S=Array.isArray;!s.JS_MD5_NO_NODE_JS&&S||(S=function(t){return"[object Array]"===Object.prototype.toString.call(t)});var _=ArrayBuffer.isView;!u||!s.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW&&_||(_=function(t){return"object"==typeof t&&t.buffer&&t.buffer.constructor===ArrayBuffer});var w=function(e){var s=typeof e;if("string"===s)return[e,!0];if("object"!==s||null===e)throw new Error(t);if(u&&e.constructor===ArrayBuffer)return[new Uint8Array(e),!1];if(!S(e)&&!_(e))throw new Error(t);return[e,!1]},A=function(t){return function(e){return new b(!0).update(e)[t]()}},$=function(e){var r,o=i,a=n.Buffer;return r=a.from&&!s.JS_MD5_NO_BUFFER_FROM?a.from:function(t){return new a(t)},function(s){if("string"==typeof s)return o.createHash("md5").update(s,"utf8").digest("hex");if(null==s)throw new Error(t);return s.constructor===ArrayBuffer&&(s=new Uint8Array(s)),S(s)||_(s)||s.constructor===a?o.createHash("md5").update(r(s)).digest("hex"):e(s)}},I=function(t){return function(e,s){return new D(e,!0).update(s)[t]()}};function b(t){if(t)g[0]=g[16]=g[1]=g[2]=g[3]=g[4]=g[5]=g[6]=g[7]=g[8]=g[9]=g[10]=g[11]=g[12]=g[13]=g[14]=g[15]=0,this.blocks=g,this.buffer8=a;else if(u){var e=new ArrayBuffer(68);this.buffer8=new Uint8Array(e),this.blocks=new Uint32Array(e)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}function D(t,e){var s,r=w(t);if(t=r[0],r[1]){var i,n=[],o=t.length,a=0;for(s=0;s<o;++s)(i=t.charCodeAt(s))<128?n[a++]=i:i<2048?(n[a++]=192|i>>>6,n[a++]=128|63&i):i<55296||i>=57344?(n[a++]=224|i>>>12,n[a++]=128|i>>>6&63,n[a++]=128|63&i):(i=65536+((1023&i)<<10|1023&t.charCodeAt(++s)),n[a++]=240|i>>>18,n[a++]=128|i>>>12&63,n[a++]=128|i>>>6&63,n[a++]=128|63&i);t=n}t.length>64&&(t=new b(!0).update(t).array());var c=[],u=[];for(s=0;s<64;++s){var d=t[s]||0;c[s]=92^d,u[s]=54^d}b.call(this,e),this.update(u),this.oKeyPad=c,this.inner=!0,this.sharedMemory=e}b.prototype.update=function(t){if(this.finalized)throw new Error("finalize already called");var e=w(t);t=e[0];for(var s,r,i=e[1],n=0,o=t.length,a=this.blocks,c=this.buffer8;n<o;){if(this.hashed&&(this.hashed=!1,a[0]=a[16],a[16]=a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=a[7]=a[8]=a[9]=a[10]=a[11]=a[12]=a[13]=a[14]=a[15]=0),i)if(u)for(r=this.start;n<o&&r<64;++n)(s=t.charCodeAt(n))<128?c[r++]=s:s<2048?(c[r++]=192|s>>>6,c[r++]=128|63&s):s<55296||s>=57344?(c[r++]=224|s>>>12,c[r++]=128|s>>>6&63,c[r++]=128|63&s):(s=65536+((1023&s)<<10|1023&t.charCodeAt(++n)),c[r++]=240|s>>>18,c[r++]=128|s>>>12&63,c[r++]=128|s>>>6&63,c[r++]=128|63&s);else for(r=this.start;n<o&&r<64;++n)(s=t.charCodeAt(n))<128?a[r>>>2]|=s<<p[3&r++]:s<2048?(a[r>>>2]|=(192|s>>>6)<<p[3&r++],a[r>>>2]|=(128|63&s)<<p[3&r++]):s<55296||s>=57344?(a[r>>>2]|=(224|s>>>12)<<p[3&r++],a[r>>>2]|=(128|s>>>6&63)<<p[3&r++],a[r>>>2]|=(128|63&s)<<p[3&r++]):(s=65536+((1023&s)<<10|1023&t.charCodeAt(++n)),a[r>>>2]|=(240|s>>>18)<<p[3&r++],a[r>>>2]|=(128|s>>>12&63)<<p[3&r++],a[r>>>2]|=(128|s>>>6&63)<<p[3&r++],a[r>>>2]|=(128|63&s)<<p[3&r++]);else if(u)for(r=this.start;n<o&&r<64;++n)c[r++]=t[n];else for(r=this.start;n<o&&r<64;++n)a[r>>>2]|=t[n]<<p[3&r++];this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this},b.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[e>>>2]|=h[3&e],e>=56&&(this.hashed||this.hash(),t[0]=t[16],t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.bytes<<3,t[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},b.prototype.hash=function(){var t,e,s,r,i,n,o=this.blocks;this.first?e=((e=((t=((t=o[0]-680876937)<<7|t>>>25)-271733879<<0)^(s=((s=(-271733879^(r=((r=(-1732584194^2004318071&t)+o[1]-117830708)<<12|r>>>20)+t<<0)&(-271733879^t))+o[2]-1126478375)<<17|s>>>15)+r<<0)&(r^t))+o[3]-1316259209)<<22|e>>>10)+s<<0:(t=this.h0,e=this.h1,s=this.h2,e=((e+=((t=((t+=((r=this.h3)^e&(s^r))+o[0]-680876936)<<7|t>>>25)+e<<0)^(s=((s+=(e^(r=((r+=(s^t&(e^s))+o[1]-389564586)<<12|r>>>20)+t<<0)&(t^e))+o[2]+606105819)<<17|s>>>15)+r<<0)&(r^t))+o[3]-1044525330)<<22|e>>>10)+s<<0),e=((e+=((t=((t+=(r^e&(s^r))+o[4]-176418897)<<7|t>>>25)+e<<0)^(s=((s+=(e^(r=((r+=(s^t&(e^s))+o[5]+1200080426)<<12|r>>>20)+t<<0)&(t^e))+o[6]-1473231341)<<17|s>>>15)+r<<0)&(r^t))+o[7]-45705983)<<22|e>>>10)+s<<0,e=((e+=((t=((t+=(r^e&(s^r))+o[8]+1770035416)<<7|t>>>25)+e<<0)^(s=((s+=(e^(r=((r+=(s^t&(e^s))+o[9]-1958414417)<<12|r>>>20)+t<<0)&(t^e))+o[10]-42063)<<17|s>>>15)+r<<0)&(r^t))+o[11]-1990404162)<<22|e>>>10)+s<<0,e=((e+=((t=((t+=(r^e&(s^r))+o[12]+1804603682)<<7|t>>>25)+e<<0)^(s=((s+=(e^(r=((r+=(s^t&(e^s))+o[13]-40341101)<<12|r>>>20)+t<<0)&(t^e))+o[14]-1502002290)<<17|s>>>15)+r<<0)&(r^t))+o[15]+1236535329)<<22|e>>>10)+s<<0,e=((e+=((r=((r+=(e^s&((t=((t+=(s^r&(e^s))+o[1]-165796510)<<5|t>>>27)+e<<0)^e))+o[6]-1069501632)<<9|r>>>23)+t<<0)^t&((s=((s+=(t^e&(r^t))+o[11]+643717713)<<14|s>>>18)+r<<0)^r))+o[0]-373897302)<<20|e>>>12)+s<<0,e=((e+=((r=((r+=(e^s&((t=((t+=(s^r&(e^s))+o[5]-701558691)<<5|t>>>27)+e<<0)^e))+o[10]+38016083)<<9|r>>>23)+t<<0)^t&((s=((s+=(t^e&(r^t))+o[15]-660478335)<<14|s>>>18)+r<<0)^r))+o[4]-405537848)<<20|e>>>12)+s<<0,e=((e+=((r=((r+=(e^s&((t=((t+=(s^r&(e^s))+o[9]+568446438)<<5|t>>>27)+e<<0)^e))+o[14]-1019803690)<<9|r>>>23)+t<<0)^t&((s=((s+=(t^e&(r^t))+o[3]-187363961)<<14|s>>>18)+r<<0)^r))+o[8]+1163531501)<<20|e>>>12)+s<<0,e=((e+=((r=((r+=(e^s&((t=((t+=(s^r&(e^s))+o[13]-1444681467)<<5|t>>>27)+e<<0)^e))+o[2]-51403784)<<9|r>>>23)+t<<0)^t&((s=((s+=(t^e&(r^t))+o[7]+1735328473)<<14|s>>>18)+r<<0)^r))+o[12]-1926607734)<<20|e>>>12)+s<<0,e=((e+=((n=(r=((r+=((i=e^s)^(t=((t+=(i^r)+o[5]-378558)<<4|t>>>28)+e<<0))+o[8]-2022574463)<<11|r>>>21)+t<<0)^t)^(s=((s+=(n^e)+o[11]+1839030562)<<16|s>>>16)+r<<0))+o[14]-35309556)<<23|e>>>9)+s<<0,e=((e+=((n=(r=((r+=((i=e^s)^(t=((t+=(i^r)+o[1]-1530992060)<<4|t>>>28)+e<<0))+o[4]+1272893353)<<11|r>>>21)+t<<0)^t)^(s=((s+=(n^e)+o[7]-155497632)<<16|s>>>16)+r<<0))+o[10]-1094730640)<<23|e>>>9)+s<<0,e=((e+=((n=(r=((r+=((i=e^s)^(t=((t+=(i^r)+o[13]+681279174)<<4|t>>>28)+e<<0))+o[0]-358537222)<<11|r>>>21)+t<<0)^t)^(s=((s+=(n^e)+o[3]-722521979)<<16|s>>>16)+r<<0))+o[6]+76029189)<<23|e>>>9)+s<<0,e=((e+=((n=(r=((r+=((i=e^s)^(t=((t+=(i^r)+o[9]-640364487)<<4|t>>>28)+e<<0))+o[12]-421815835)<<11|r>>>21)+t<<0)^t)^(s=((s+=(n^e)+o[15]+530742520)<<16|s>>>16)+r<<0))+o[2]-995338651)<<23|e>>>9)+s<<0,e=((e+=((r=((r+=(e^((t=((t+=(s^(e|~r))+o[0]-198630844)<<6|t>>>26)+e<<0)|~s))+o[7]+1126891415)<<10|r>>>22)+t<<0)^((s=((s+=(t^(r|~e))+o[14]-1416354905)<<15|s>>>17)+r<<0)|~t))+o[5]-57434055)<<21|e>>>11)+s<<0,e=((e+=((r=((r+=(e^((t=((t+=(s^(e|~r))+o[12]+1700485571)<<6|t>>>26)+e<<0)|~s))+o[3]-1894986606)<<10|r>>>22)+t<<0)^((s=((s+=(t^(r|~e))+o[10]-1051523)<<15|s>>>17)+r<<0)|~t))+o[1]-2054922799)<<21|e>>>11)+s<<0,e=((e+=((r=((r+=(e^((t=((t+=(s^(e|~r))+o[8]+1873313359)<<6|t>>>26)+e<<0)|~s))+o[15]-30611744)<<10|r>>>22)+t<<0)^((s=((s+=(t^(r|~e))+o[6]-1560198380)<<15|s>>>17)+r<<0)|~t))+o[13]+1309151649)<<21|e>>>11)+s<<0,e=((e+=((r=((r+=(e^((t=((t+=(s^(e|~r))+o[4]-145523070)<<6|t>>>26)+e<<0)|~s))+o[11]-1120210379)<<10|r>>>22)+t<<0)^((s=((s+=(t^(r|~e))+o[2]+718787259)<<15|s>>>17)+r<<0)|~t))+o[9]-343485551)<<21|e>>>11)+s<<0,this.first?(this.h0=t+1732584193<<0,this.h1=e-271733879<<0,this.h2=s-1732584194<<0,this.h3=r+271733878<<0,this.first=!1):(this.h0=this.h0+t<<0,this.h1=this.h1+e<<0,this.h2=this.h2+s<<0,this.h3=this.h3+r<<0)},b.prototype.hex=function(){this.finalize();var t=this.h0,e=this.h1,s=this.h2,r=this.h3;return d[t>>>4&15]+d[15&t]+d[t>>>12&15]+d[t>>>8&15]+d[t>>>20&15]+d[t>>>16&15]+d[t>>>28&15]+d[t>>>24&15]+d[e>>>4&15]+d[15&e]+d[e>>>12&15]+d[e>>>8&15]+d[e>>>20&15]+d[e>>>16&15]+d[e>>>28&15]+d[e>>>24&15]+d[s>>>4&15]+d[15&s]+d[s>>>12&15]+d[s>>>8&15]+d[s>>>20&15]+d[s>>>16&15]+d[s>>>28&15]+d[s>>>24&15]+d[r>>>4&15]+d[15&r]+d[r>>>12&15]+d[r>>>8&15]+d[r>>>20&15]+d[r>>>16&15]+d[r>>>28&15]+d[r>>>24&15]},b.prototype.toString=b.prototype.hex,b.prototype.digest=function(){this.finalize();var t=this.h0,e=this.h1,s=this.h2,r=this.h3;return[255&t,t>>>8&255,t>>>16&255,t>>>24&255,255&e,e>>>8&255,e>>>16&255,e>>>24&255,255&s,s>>>8&255,s>>>16&255,s>>>24&255,255&r,r>>>8&255,r>>>16&255,r>>>24&255]},b.prototype.array=b.prototype.digest,b.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(16),e=new Uint32Array(t);return e[0]=this.h0,e[1]=this.h1,e[2]=this.h2,e[3]=this.h3,t},b.prototype.buffer=b.prototype.arrayBuffer,b.prototype.base64=function(){for(var t,e,s,r="",i=this.array(),n=0;n<15;)t=i[n++],e=i[n++],s=i[n++],r+=m[t>>>2]+m[63&(t<<4|e>>>4)]+m[63&(e<<2|s>>>6)]+m[63&s];return t=i[n],r+=m[t>>>2]+m[t<<4&63]+"=="},D.prototype=new b,D.prototype.finalize=function(){if(b.prototype.finalize.call(this),this.inner){this.inner=!1;var t=this.array();b.call(this,this.sharedMemory),this.update(this.oKeyPad),this.update(t),b.prototype.finalize.call(this)}};var O=function(){var t=A("hex");o&&(t=$(t)),t.create=function(){return new b},t.update=function(e){return t.create().update(e)};for(var e=0;e<y.length;++e){var s=y[e];t[s]=A(s)}return t}();O.md5=O,O.md5.hmac=function(){var t=I("hex");t.create=function(t){return new D(t)},t.update=function(e,s){return t.create(e).update(s)};for(var e=0;e<y.length;++e){var s=y[e];t[s]=I(s)}return t}(),c?f.exports=O:s.md5=O}();var y=p.exports;function m(t){let e,s=t[0],r=1;for(;r<t.length;){const i=t[r],n=t[r+1];if(r+=2,("optionalAccess"===i||"optionalCall"===i)&&null==s)return;"access"===i||"optionalAccess"===i?(e=s,s=n(s)):"call"!==i&&"optionalCall"!==i||(s=n(((...t)=>s.call(e,...t))),e=void 0)}return s}class g{__init(){this.studentList=[]}__init2(){this.codeStart=0}__init3(){this.classid=0}constructor(t){g.prototype.__init.call(this),g.prototype.__init2.call(this),g.prototype.__init3.call(this);const e=t%100,s=Math.floor(t/100)%100;this.classid=t;const r={9:{schoolId:39,classId:1},10:{schoolId:39,classId:2},11:{schoolId:9,classId:9},12:{schoolId:9,classId:10}};if(Object.entries(r).map((t=>t[0].toString())).includes(e.toString())){const t=r[e];this.codeStart=1e4*t.schoolId+100*s+t.classId}else{const t=e%100;this.codeStart=t<10?9e4+100*s+e:39e4+100*s+e%10}}appendUser(t){this.studentList.push(t),console.log("Stored user with id",t.id,"in _id",t._id,"into class",this.classid)}removeUser(t){this.studentList=this.studentList.filter((e=>e._id!==t))}getUserCode(t){const e=this.studentList.findIndex((e=>e._id===t));return 100*this.codeStart+e+1}getUser(t){return this.studentList.find((e=>e._id===t))}}class v{__init4(){this.classList=[]}constructor(){v.prototype.__init4.call(this);for(let t=2022;t<=2023;t++)for(let e=1;e<=17;e++)this.classList.push(new g(100*t+e))}appendUser(t){console.log("Append user",t.id,"into class",Math.floor(t.id/100));const e=this.classList.findIndex((e=>e.classid===Math.floor(t.id/100)));-1!==e&&this.classList[e].appendUser(t)}removeUser(t,e){m([this.classList.find((t=>t.classid===e)),"optionalAccess",t=>t.removeUser,"call",e=>e(t)])}getUserCode(t,e){const s=this.classList.findIndex((t=>t.classid===e));if(-1!==s)return this.classList[s].getUserCode(t)}studentExchange(t){const e=Math.floor(t.previous/100),s=t.toClass,r=this.classList.find((t=>t.classid===e)),i=this.classList.find((t=>t.classid===s));if(r&&i){const n=r.getUser(t._id);n&&(r.removeUser(t._id),i.appendUser(n),console.log("Student",t._id,"exchanged from",e,"to",s,"with new code",this.getUserCode(t._id,s)))}}getClassStudentList(t,e){return m([this.classList.find((s=>s.classid===100*t+e)),"optionalAccess",t=>t.studentList])}getClassWithCode(t){return m([this.classList.find((e=>e.codeStart===Math.floor(t/100))),"optionalAccess",t=>t.classid])}}function S(t,e){return null!=t?t:e()}function _(t){let e,s=t[0],r=1;for(;r<t.length;){const i=t[r],n=t[r+1];if(r+=2,("optionalAccess"===i||"optionalCall"===i)&&null==s)return;"access"===i||"optionalAccess"===i?(e=s,s=n(s)):"call"!==i&&"optionalCall"!==i||(s=n(((...t)=>s.call(e,...t))),e=void 0)}return s}const w=new v;function A(t){const e=1&t,s=2&t,r=4&t,i=8&t,n=16&t,o=32&t;return["student","secretary","department","auditor","inspector","admin","system"].filter(((t,a)=>[true,e,s,r,i,n,o][a]))}function $(t){return t.map((t=>function(t){const e={_id:new r.ObjectId,id:t.userid,name:t.username,sex:"unknown",position:A(t.permission),code:100*t.classid+t.userid%100};if(t.userid>20219999){w.appendUser({id:e.id,_id:e._id.toString(),name:e.name});const t=w.getUserCode(e._id.toString(),Math.floor(e.id/100));t&&(e.code=t)}return console.log("Transformed user",t.userid,"with code",e.code),e}(t))).map((t=>function(t){return{...t,password:y.md5(t.id.toString())}}(t)))}const I=[];function b(t){if(0===I.length){const t=s.readFileSync(e.resolve("data","handler","user-transformed.json"),"utf-8");I.push(...JSON.parse(t))}const i=_([I,"access",t=>t.find,"call",e=>e((e=>e.id===t)),"optionalAccess",t=>t._id]);if(i)return console.log("Found user",t,"with id",i),new r.ObjectId(i);throw new Error("User not found")}function D(t){return t.filter((t=>!t.userid.toString().startsWith(t.classid.toString()))).map((t=>{w.studentExchange({_id:b(t.userid).toString(),toClass:t.classid,previous:t.userid});const e={_id:b(t.userid),id:t.userid,name:t.username,code:w.getUserCode(b(t.userid).toString(),t.classid)};if(t.userid>20229999&&e.code){const s=e.code%100;e.id=100*t.classid+s}return e}))}function O(){return _([w,"access",t=>t.getClassStudentList,"call",t=>t(2023,2),"optionalAccess",t=>t.map,"call",t=>t((t=>{const e=S(w.getUserCode(t._id,202302),(()=>0));return{_id:t._id,id:20230200+e%100,name:t.name,code:e}})),"access",t=>t.sort,"call",t=>t(((t,e)=>t.code-e.code))])}var M,E,C,N;!function(t){t[t.UNAUDITED=1]="UNAUDITED";t[t.ACCEPTED=2]="ACCEPTED";t[t.REJECTED=3]="REJECTED";t[t.SPECIAL=4]="SPECIAL"}(M||(M={})),function(t){t[t.WAITING_FOR_SIGNUP_AUDIT=1]="WAITING_FOR_SIGNUP_AUDIT";t[t.DRAFT=2]="DRAFT";t[t.WAITING_FOR_FIRST_AUDIT=3]="WAITING_FOR_FIRST_AUDIT";t[t.WAITING_FOR_FINAL_AUDIT=4]="WAITING_FOR_FINAL_AUDIT";t[t.ACCEPTED=5]="ACCEPTED";t[t.REJECTED=6]="REJECTED";t[t.SPIKE=7]="SPIKE"}(E||(E={})),function(t){t[t.INSIDE=1]="INSIDE";t[t.OUTSIDE=2]="OUTSIDE";t[t.LARGE=3]="LARGE"}(C||(C={})),function(t){t[t.INSIDE=1]="INSIDE";t[t.APPOINTED=2]="APPOINTED";t[t.SPECIAL=3]="SPECIAL"}(N||(N={}));const x=["","pending","effective","refused","effective"],U=["","specified","social","scale","special"],T=["","on-campus","off-campus","social-practice"],j=["","draft","draft","pending","pending","effective","refused","rejected"];function F(t){return T[t]}function L(t){return j[t]}var J={exports:{}},W=h(J.exports=function(){var t=1e3,e=6e4,s=36e5,r="millisecond",i="second",n="minute",o="hour",a="day",c="week",u="month",d="quarter",l="year",h="date",f="Invalid Date",p=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,y=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,m={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(t){var e=["th","st","nd","rd"],s=t%100;return"["+t+(e[(s-20)%10]||e[s]||e[0])+"]"}},g=function(t,e,s){var r=String(t);return!r||r.length>=e?t:""+Array(e+1-r.length).join(s)+t},v={s:g,z:function(t){var e=-t.utcOffset(),s=Math.abs(e),r=Math.floor(s/60),i=s%60;return(e<=0?"+":"-")+g(r,2,"0")+":"+g(i,2,"0")},m:function t(e,s){if(e.date()<s.date())return-t(s,e);var r=12*(s.year()-e.year())+(s.month()-e.month()),i=e.clone().add(r,u),n=s-i<0,o=e.clone().add(r+(n?-1:1),u);return+(-(r+(s-i)/(n?i-o:o-i))||0)},a:function(t){return t<0?Math.ceil(t)||0:Math.floor(t)},p:function(t){return{M:u,y:l,w:c,d:a,D:h,h:o,m:n,s:i,ms:r,Q:d}[t]||String(t||"").toLowerCase().replace(/s$/,"")},u:function(t){return void 0===t}},S="en",_={};_[S]=m;var w="$isDayjsObject",A=function(t){return t instanceof D||!(!t||!t[w])},$=function t(e,s,r){var i;if(!e)return S;if("string"==typeof e){var n=e.toLowerCase();_[n]&&(i=n),s&&(_[n]=s,i=n);var o=e.split("-");if(!i&&o.length>1)return t(o[0])}else{var a=e.name;_[a]=e,i=a}return!r&&i&&(S=i),i||!r&&S},I=function(t,e){if(A(t))return t.clone();var s="object"==typeof e?e:{};return s.date=t,s.args=arguments,new D(s)},b=v;b.l=$,b.i=A,b.w=function(t,e){return I(t,{locale:e.$L,utc:e.$u,x:e.$x,$offset:e.$offset})};var D=function(){function m(t){this.$L=$(t.locale,null,!0),this.parse(t),this.$x=this.$x||t.x||{},this[w]=!0}var g=m.prototype;return g.parse=function(t){this.$d=function(t){var e=t.date,s=t.utc;if(null===e)return new Date(NaN);if(b.u(e))return new Date;if(e instanceof Date)return new Date(e);if("string"==typeof e&&!/Z$/i.test(e)){var r=e.match(p);if(r){var i=r[2]-1||0,n=(r[7]||"0").substring(0,3);return s?new Date(Date.UTC(r[1],i,r[3]||1,r[4]||0,r[5]||0,r[6]||0,n)):new Date(r[1],i,r[3]||1,r[4]||0,r[5]||0,r[6]||0,n)}}return new Date(e)}(t),this.init()},g.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},g.$utils=function(){return b},g.isValid=function(){return!(this.$d.toString()===f)},g.isSame=function(t,e){var s=I(t);return this.startOf(e)<=s&&s<=this.endOf(e)},g.isAfter=function(t,e){return I(t)<this.startOf(e)},g.isBefore=function(t,e){return this.endOf(e)<I(t)},g.$g=function(t,e,s){return b.u(t)?this[e]:this.set(s,t)},g.unix=function(){return Math.floor(this.valueOf()/1e3)},g.valueOf=function(){return this.$d.getTime()},g.startOf=function(t,e){var s=this,r=!!b.u(e)||e,d=b.p(t),f=function(t,e){var i=b.w(s.$u?Date.UTC(s.$y,e,t):new Date(s.$y,e,t),s);return r?i:i.endOf(a)},p=function(t,e){return b.w(s.toDate()[t].apply(s.toDate("s"),(r?[0,0,0,0]:[23,59,59,999]).slice(e)),s)},y=this.$W,m=this.$M,g=this.$D,v="set"+(this.$u?"UTC":"");switch(d){case l:return r?f(1,0):f(31,11);case u:return r?f(1,m):f(0,m+1);case c:var S=this.$locale().weekStart||0,_=(y<S?y+7:y)-S;return f(r?g-_:g+(6-_),m);case a:case h:return p(v+"Hours",0);case o:return p(v+"Minutes",1);case n:return p(v+"Seconds",2);case i:return p(v+"Milliseconds",3);default:return this.clone()}},g.endOf=function(t){return this.startOf(t,!1)},g.$set=function(t,e){var s,c=b.p(t),d="set"+(this.$u?"UTC":""),f=(s={},s[a]=d+"Date",s[h]=d+"Date",s[u]=d+"Month",s[l]=d+"FullYear",s[o]=d+"Hours",s[n]=d+"Minutes",s[i]=d+"Seconds",s[r]=d+"Milliseconds",s)[c],p=c===a?this.$D+(e-this.$W):e;if(c===u||c===l){var y=this.clone().set(h,1);y.$d[f](p),y.init(),this.$d=y.set(h,Math.min(this.$D,y.daysInMonth())).$d}else f&&this.$d[f](p);return this.init(),this},g.set=function(t,e){return this.clone().$set(t,e)},g.get=function(t){return this[b.p(t)]()},g.add=function(r,d){var h,f=this;r=Number(r);var p=b.p(d),y=function(t){var e=I(f);return b.w(e.date(e.date()+Math.round(t*r)),f)};if(p===u)return this.set(u,this.$M+r);if(p===l)return this.set(l,this.$y+r);if(p===a)return y(1);if(p===c)return y(7);var m=(h={},h[n]=e,h[o]=s,h[i]=t,h)[p]||1,g=this.$d.getTime()+r*m;return b.w(g,this)},g.subtract=function(t,e){return this.add(-1*t,e)},g.format=function(t){var e=this,s=this.$locale();if(!this.isValid())return s.invalidDate||f;var r=t||"YYYY-MM-DDTHH:mm:ssZ",i=b.z(this),n=this.$H,o=this.$m,a=this.$M,c=s.weekdays,u=s.months,d=s.meridiem,l=function(t,s,i,n){return t&&(t[s]||t(e,r))||i[s].slice(0,n)},h=function(t){return b.s(n%12||12,t,"0")},p=d||function(t,e,s){var r=t<12?"AM":"PM";return s?r.toLowerCase():r};return r.replace(y,(function(t,r){return r||function(t){switch(t){case"YY":return String(e.$y).slice(-2);case"YYYY":return b.s(e.$y,4,"0");case"M":return a+1;case"MM":return b.s(a+1,2,"0");case"MMM":return l(s.monthsShort,a,u,3);case"MMMM":return l(u,a);case"D":return e.$D;case"DD":return b.s(e.$D,2,"0");case"d":return String(e.$W);case"dd":return l(s.weekdaysMin,e.$W,c,2);case"ddd":return l(s.weekdaysShort,e.$W,c,3);case"dddd":return c[e.$W];case"H":return String(n);case"HH":return b.s(n,2,"0");case"h":return h(1);case"hh":return h(2);case"a":return p(n,o,!0);case"A":return p(n,o,!1);case"m":return String(o);case"mm":return b.s(o,2,"0");case"s":return String(e.$s);case"ss":return b.s(e.$s,2,"0");case"SSS":return b.s(e.$ms,3,"0");case"Z":return i}return null}(t)||i.replace(":","")}))},g.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},g.diff=function(r,h,f){var p,y=this,m=b.p(h),g=I(r),v=(g.utcOffset()-this.utcOffset())*e,S=this-g,_=function(){return b.m(y,g)};switch(m){case l:p=_()/12;break;case u:p=_();break;case d:p=_()/3;break;case c:p=(S-v)/6048e5;break;case a:p=(S-v)/864e5;break;case o:p=S/s;break;case n:p=S/e;break;case i:p=S/t;break;default:p=S}return f?p:b.a(p)},g.daysInMonth=function(){return this.endOf(u).$D},g.$locale=function(){return _[this.$L]},g.locale=function(t,e){if(!t)return this.$L;var s=this.clone(),r=$(t,e,!0);return r&&(s.$L=r),s},g.clone=function(){return b.w(this.$d,this)},g.toDate=function(){return new Date(this.valueOf())},g.toJSON=function(){return this.isValid()?this.toISOString():null},g.toISOString=function(){return this.$d.toISOString()},g.toString=function(){return this.$d.toUTCString()},m}(),O=D.prototype;return I.prototype=O,[["$ms",r],["$s",i],["$m",n],["$H",o],["$W",a],["$M",u],["$y",l],["$D",h]].forEach((function(t){O[t[1]]=function(e){return this.$g(e,t[0],t[1])}})),I.extend=function(t,e){return t.$i||(t(e,D,I),t.$i=!0),I},I.locale=$,I.isDayjs=A,I.unix=function(t){return I(1e3*t)},I.en=_[S],I.Ls=_,I.p={},I}());const k=new Map,R=[];function P(t){if(t.description.startsWith("append to #")){const e=t.description.replaceAll("\\n","\n").split("\n").map((t=>t.trim())),s=parseInt(e[0].split("#")[1]);if(isNaN(s))return t.id;function r(t){return-1!==R.findIndex((e=>e.id===t))}return r(s)?k.has(s)?k.get(s):(k.set(t.id,s),s):t.id}return t.id}function B(t){return t.map((t=>{console.log("Transforming activity",t.id,"with status",t.status);const e=function(t){return x[t]}(t.status),s=0===t.holder?"special":function(t,e,s=!1){return e===M.SPECIAL||s?"special":U[t]}(t.type,t.status),i={_id:new r.ObjectId,type:s,name:t.name.replaceAll("（其他）","").replaceAll("（社团）","").replaceAll("（获奖）","").trim(),description:t.description.replaceAll("自提交义工：","").trim(),members:[],duration:t.reward/60,date:W(t.time).toISOString(),createdAt:W().toISOString(),updatedAt:W().toISOString(),creator:b(t.holder).toString(),status:e,oid:P(t)},n={classify:0===t.holder?"import":t.name.endsWith("（其他）")?"other":t.name.endsWith("（社团）")?"club":"other",mode:F(t.type)},o={place:"可莉不知道哦",deadline:W(t.time).toISOString(),classes:[]};return"specified"===i.type?(console.log("It is a specified activity."),{...i,registration:o}):"special"===i.type?(console.log("It is a special activity."),{...i,special:n}):i}))}function z(t,e,s,r=[]){const i=L(t.status);return console.log("Transforming member",t.userid,"with status",i),{_id:b(t.userid).toString(),status:i,mode:e,impression:t.thought,duration:(n=t.reward/60,o=()=>s,null!=n?n:o()),history:[],images:r};var n,o}function H(t,e,s=[],r=[]){return e.map((e=>{const r=(i=e.volid,console.log("Checking activity oid",i),k.has(i)?k.get(i):i);var i;const n=t.findIndex((t=>t.oid===r));if(n){console.log("Appending member",e.userid,"into activity",n);const r=t[n],i=s.filter((t=>t.volid===e.volid&&t.userid===e.userid)).map((t=>t.filename)),o=function(t){const e=R.findIndex((e=>e.id===t));return-1===e?"on-campus":F(R[e].type)}(e.volid);if(console.log("Appending member",e.userid,"with mode",o),"special"===r.type)r.members.push(z(e,o,r.duration,i));else if(-1===r.members.findIndex((t=>t._id===b(e.userid).toString())))r.members.push(z(e,o,r.duration,i));else{console.log("Member",e.userid,"already exists in activity",n);const t=r.members.find((t=>t._id===b(e.userid).toString()));t&&(t.images=t.images.concat(i),t.duration+=e.reward/60,"effective"===t.status?t.impression+="\n"+e.thought:"refused"!==t.status&&"rejected"!==t.status||(t.impression=e.thought,t.status="effective"===L(e.status)?"effective":t.status))}}})),t.map((t=>{const e=r.filter((e=>e.volid===t.oid));return 0===e.length?console.log("No classes found for activity",t.oid):console.log("Appending classes",e.map((t=>t.classid)).join(", "),"into activity",t.oid),0!==e.length&&"specified"===t.type?{...t,registration:{...t.registration,classes:e.map((t=>({class:t.classid,min:0,max:t.max})))}}:t})).filter((t=>0!==t.members.length&&!t.description.includes(".ignore")&&!t.description.includes("测试")&&!t.name.includes("测试"))).map((t=>(delete t.oid,t)))}function Y(){!function(){if(0===R.length){const t=s.readFileSync(e.resolve("data","export","volunteer.json"),"utf-8"),r=JSON.parse(t);R.push(...r)}}();const t=s.readFileSync(e.resolve("data","export","volunteer.json"),"utf-8"),r=JSON.parse(t),i=s.readFileSync(e.resolve("data","export","user_vol.json"),"utf-8"),n=JSON.parse(i),o=s.readFileSync(e.resolve("data","export","picture.json"),"utf-8"),a=JSON.parse(o),c=s.readFileSync(e.resolve("data","export","class_vol.json"),"utf-8"),u=JSON.parse(c),d=H(B(r),n,a,u);s.writeFileSync(e.resolve("data","handler","activity-transformed.json"),JSON.stringify(d,null,2))}!async function(){console.time("export"),await d(),function(){const t=s.readFileSync(e.resolve("data","export","user.json"),"utf-8"),r=JSON.parse(t),i=$(r);s.writeFileSync(e.resolve("data","handler","user-transformed.json"),JSON.stringify(i,null,2));const n=[D(r),O()].flat(1);s.writeFileSync(e.resolve("data","handler","mappings.json"),JSON.stringify(n.filter((t=>_([t,"optionalAccess",t=>t.code])&&t)),null,2)),s.writeFileSync(e.resolve("data","handler","classid-changed.json"),JSON.stringify(D(r),null,2)),s.writeFileSync(e.resolve("data","handler","class2-2023.json"),JSON.stringify(O(),null,2))}(),Y(),function(){const t=s.readFileSync(e.resolve("data","handler","user-transformed.json"),"utf-8"),r=s.readFileSync(e.resolve("data","handler","mappings.json"),"utf-8"),i=function(t,e){return t.map((t=>{if(t.id>20219999){const s=e.find((e=>e._id===t._id.toString()));return s?{...t,id:s.id,code:s.code,password:s.id}:t}return t}))}(JSON.parse(t),JSON.parse(r)).map((t=>(console.log("Mapped user",t.id,"with code",t.code,"in class",w.getClassWithCode(t.code),"with updated id:",w.getUserCode(t._id.toString(),S(w.getClassWithCode(t.code),(()=>0)))),t.code=S(w.getUserCode(t._id.toString(),S(w.getClassWithCode(t.code),(()=>0))),(()=>t.code)),t.name=t.name.replace(/[A-Za-z0-9]+/,""),t)));s.writeFileSync(e.resolve("data","handler","user-transformed-mapped.json"),JSON.stringify(i,null,2))}(),await async function(){const t=await o.readFile(e.resolve("data","handler","user-transformed-mapped.json"),"utf-8"),s=JSON.parse(t).map((async t=>{const e=await a.genSalt(),s=await a.hash(t.id.toString(),e);return console.log("Hashed password",t.id,"to",s,"for user",t.id),{...t,password:s,_id:{$oid:t._id}}})),r=await Promise.all(s);await o.writeFile(e.resolve("data","import","users.json"),JSON.stringify(r,null,"\t")),console.log("Exported the users in",e.resolve("data","import","users.json"))}(),await async function(){const t=await o.readFile(e.resolve("data","handler","activity-transformed.json"),"utf-8"),s=JSON.parse(t).map((t=>({...t,_id:{$oid:t._id}})));await o.writeFile(e.resolve("data","import","activities.json"),JSON.stringify(s,null,"\t")),console.log("Exported the activities in",e.resolve("data","import","activities.json")),console.log("Now you can import the data into MongoDB using `mongoimport` with the following command:"),console.log("mongoimport --db <database> --collection <collection> --file <file> --jsonArray"),console.log("Example:"),console.log("mongoimport --db test --collection users --file users.json --jsonArray")}(),console.timeEnd("export")}();
