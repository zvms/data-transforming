"use strict";var t=require("sqlite3"),e=require("path"),r=require("fs"),s=require("mongodb"),n=require("crypto"),i=require("buffer");const o=["volunteer","user","class","class_vol","user_vol","picture","issue","notice","user_notice","class_notice"];function a(t){const e=o.map((e=>new Promise(((r,s)=>{t.all(`SELECT * FROM ${e}`,((t,n)=>{t&&s(t),r({key:e,value:n})}))}))));return Promise.all(e)}async function c(){const s=function(){const r=e.resolve("database","zvms.db");return new t.Database(r)}(),n=e.resolve("data","export");(await a(s)).forEach((t=>{console.log("Exporting table",t.key),r.writeFileSync(e.resolve(n,t.key+".json"),JSON.stringify(t.value,null,2))}))}var u="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function d(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var l,h={exports:{}};
/**
 * [js-md5]{@link https://github.com/emn178/js-md5}
 *
 * @namespace md5
 * @version 0.8.3
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2023
 * @license MIT
 */l=h,function(){var t="input is invalid type",e="object"==typeof window,r=e?window:{};r.JS_MD5_NO_WINDOW&&(e=!1);var s=!e&&"object"==typeof self,o=!r.JS_MD5_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;o?r=u:s&&(r=self);var a,c=!r.JS_MD5_NO_COMMON_JS&&l.exports,d=!r.JS_MD5_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,h="0123456789abcdef".split(""),f=[128,32768,8388608,-2147483648],p=[0,8,16,24],y=["hex","array","digest","buffer","arrayBuffer","base64"],g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),v=[];if(d){var S=new ArrayBuffer(68);a=new Uint8Array(S),v=new Uint32Array(S)}var m=Array.isArray;!r.JS_MD5_NO_NODE_JS&&m||(m=function(t){return"[object Array]"===Object.prototype.toString.call(t)});var _=ArrayBuffer.isView;!d||!r.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW&&_||(_=function(t){return"object"==typeof t&&t.buffer&&t.buffer.constructor===ArrayBuffer});var w=function(e){var r=typeof e;if("string"===r)return[e,!0];if("object"!==r||null===e)throw new Error(t);if(d&&e.constructor===ArrayBuffer)return[new Uint8Array(e),!1];if(!m(e)&&!_(e))throw new Error(t);return[e,!1]},$=function(t){return function(e){return new D(!0).update(e)[t]()}},A=function(e){var s,o=n,a=i.Buffer;return s=a.from&&!r.JS_MD5_NO_BUFFER_FROM?a.from:function(t){return new a(t)},function(r){if("string"==typeof r)return o.createHash("md5").update(r,"utf8").digest("hex");if(null==r)throw new Error(t);return r.constructor===ArrayBuffer&&(r=new Uint8Array(r)),m(r)||_(r)||r.constructor===a?o.createHash("md5").update(s(r)).digest("hex"):e(r)}},I=function(t){return function(e,r){return new O(e,!0).update(r)[t]()}};function D(t){if(t)v[0]=v[16]=v[1]=v[2]=v[3]=v[4]=v[5]=v[6]=v[7]=v[8]=v[9]=v[10]=v[11]=v[12]=v[13]=v[14]=v[15]=0,this.blocks=v,this.buffer8=a;else if(d){var e=new ArrayBuffer(68);this.buffer8=new Uint8Array(e),this.blocks=new Uint32Array(e)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}function O(t,e){var r,s=w(t);if(t=s[0],s[1]){var n,i=[],o=t.length,a=0;for(r=0;r<o;++r)(n=t.charCodeAt(r))<128?i[a++]=n:n<2048?(i[a++]=192|n>>>6,i[a++]=128|63&n):n<55296||n>=57344?(i[a++]=224|n>>>12,i[a++]=128|n>>>6&63,i[a++]=128|63&n):(n=65536+((1023&n)<<10|1023&t.charCodeAt(++r)),i[a++]=240|n>>>18,i[a++]=128|n>>>12&63,i[a++]=128|n>>>6&63,i[a++]=128|63&n);t=i}t.length>64&&(t=new D(!0).update(t).array());var c=[],u=[];for(r=0;r<64;++r){var d=t[r]||0;c[r]=92^d,u[r]=54^d}D.call(this,e),this.update(u),this.oKeyPad=c,this.inner=!0,this.sharedMemory=e}D.prototype.update=function(t){if(this.finalized)throw new Error("finalize already called");var e=w(t);t=e[0];for(var r,s,n=e[1],i=0,o=t.length,a=this.blocks,c=this.buffer8;i<o;){if(this.hashed&&(this.hashed=!1,a[0]=a[16],a[16]=a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=a[7]=a[8]=a[9]=a[10]=a[11]=a[12]=a[13]=a[14]=a[15]=0),n)if(d)for(s=this.start;i<o&&s<64;++i)(r=t.charCodeAt(i))<128?c[s++]=r:r<2048?(c[s++]=192|r>>>6,c[s++]=128|63&r):r<55296||r>=57344?(c[s++]=224|r>>>12,c[s++]=128|r>>>6&63,c[s++]=128|63&r):(r=65536+((1023&r)<<10|1023&t.charCodeAt(++i)),c[s++]=240|r>>>18,c[s++]=128|r>>>12&63,c[s++]=128|r>>>6&63,c[s++]=128|63&r);else for(s=this.start;i<o&&s<64;++i)(r=t.charCodeAt(i))<128?a[s>>>2]|=r<<p[3&s++]:r<2048?(a[s>>>2]|=(192|r>>>6)<<p[3&s++],a[s>>>2]|=(128|63&r)<<p[3&s++]):r<55296||r>=57344?(a[s>>>2]|=(224|r>>>12)<<p[3&s++],a[s>>>2]|=(128|r>>>6&63)<<p[3&s++],a[s>>>2]|=(128|63&r)<<p[3&s++]):(r=65536+((1023&r)<<10|1023&t.charCodeAt(++i)),a[s>>>2]|=(240|r>>>18)<<p[3&s++],a[s>>>2]|=(128|r>>>12&63)<<p[3&s++],a[s>>>2]|=(128|r>>>6&63)<<p[3&s++],a[s>>>2]|=(128|63&r)<<p[3&s++]);else if(d)for(s=this.start;i<o&&s<64;++i)c[s++]=t[i];else for(s=this.start;i<o&&s<64;++i)a[s>>>2]|=t[i]<<p[3&s++];this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this},D.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[e>>>2]|=f[3&e],e>=56&&(this.hashed||this.hash(),t[0]=t[16],t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.bytes<<3,t[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},D.prototype.hash=function(){var t,e,r,s,n,i,o=this.blocks;this.first?e=((e=((t=((t=o[0]-680876937)<<7|t>>>25)-271733879<<0)^(r=((r=(-271733879^(s=((s=(-1732584194^2004318071&t)+o[1]-117830708)<<12|s>>>20)+t<<0)&(-271733879^t))+o[2]-1126478375)<<17|r>>>15)+s<<0)&(s^t))+o[3]-1316259209)<<22|e>>>10)+r<<0:(t=this.h0,e=this.h1,r=this.h2,e=((e+=((t=((t+=((s=this.h3)^e&(r^s))+o[0]-680876936)<<7|t>>>25)+e<<0)^(r=((r+=(e^(s=((s+=(r^t&(e^r))+o[1]-389564586)<<12|s>>>20)+t<<0)&(t^e))+o[2]+606105819)<<17|r>>>15)+s<<0)&(s^t))+o[3]-1044525330)<<22|e>>>10)+r<<0),e=((e+=((t=((t+=(s^e&(r^s))+o[4]-176418897)<<7|t>>>25)+e<<0)^(r=((r+=(e^(s=((s+=(r^t&(e^r))+o[5]+1200080426)<<12|s>>>20)+t<<0)&(t^e))+o[6]-1473231341)<<17|r>>>15)+s<<0)&(s^t))+o[7]-45705983)<<22|e>>>10)+r<<0,e=((e+=((t=((t+=(s^e&(r^s))+o[8]+1770035416)<<7|t>>>25)+e<<0)^(r=((r+=(e^(s=((s+=(r^t&(e^r))+o[9]-1958414417)<<12|s>>>20)+t<<0)&(t^e))+o[10]-42063)<<17|r>>>15)+s<<0)&(s^t))+o[11]-1990404162)<<22|e>>>10)+r<<0,e=((e+=((t=((t+=(s^e&(r^s))+o[12]+1804603682)<<7|t>>>25)+e<<0)^(r=((r+=(e^(s=((s+=(r^t&(e^r))+o[13]-40341101)<<12|s>>>20)+t<<0)&(t^e))+o[14]-1502002290)<<17|r>>>15)+s<<0)&(s^t))+o[15]+1236535329)<<22|e>>>10)+r<<0,e=((e+=((s=((s+=(e^r&((t=((t+=(r^s&(e^r))+o[1]-165796510)<<5|t>>>27)+e<<0)^e))+o[6]-1069501632)<<9|s>>>23)+t<<0)^t&((r=((r+=(t^e&(s^t))+o[11]+643717713)<<14|r>>>18)+s<<0)^s))+o[0]-373897302)<<20|e>>>12)+r<<0,e=((e+=((s=((s+=(e^r&((t=((t+=(r^s&(e^r))+o[5]-701558691)<<5|t>>>27)+e<<0)^e))+o[10]+38016083)<<9|s>>>23)+t<<0)^t&((r=((r+=(t^e&(s^t))+o[15]-660478335)<<14|r>>>18)+s<<0)^s))+o[4]-405537848)<<20|e>>>12)+r<<0,e=((e+=((s=((s+=(e^r&((t=((t+=(r^s&(e^r))+o[9]+568446438)<<5|t>>>27)+e<<0)^e))+o[14]-1019803690)<<9|s>>>23)+t<<0)^t&((r=((r+=(t^e&(s^t))+o[3]-187363961)<<14|r>>>18)+s<<0)^s))+o[8]+1163531501)<<20|e>>>12)+r<<0,e=((e+=((s=((s+=(e^r&((t=((t+=(r^s&(e^r))+o[13]-1444681467)<<5|t>>>27)+e<<0)^e))+o[2]-51403784)<<9|s>>>23)+t<<0)^t&((r=((r+=(t^e&(s^t))+o[7]+1735328473)<<14|r>>>18)+s<<0)^s))+o[12]-1926607734)<<20|e>>>12)+r<<0,e=((e+=((i=(s=((s+=((n=e^r)^(t=((t+=(n^s)+o[5]-378558)<<4|t>>>28)+e<<0))+o[8]-2022574463)<<11|s>>>21)+t<<0)^t)^(r=((r+=(i^e)+o[11]+1839030562)<<16|r>>>16)+s<<0))+o[14]-35309556)<<23|e>>>9)+r<<0,e=((e+=((i=(s=((s+=((n=e^r)^(t=((t+=(n^s)+o[1]-1530992060)<<4|t>>>28)+e<<0))+o[4]+1272893353)<<11|s>>>21)+t<<0)^t)^(r=((r+=(i^e)+o[7]-155497632)<<16|r>>>16)+s<<0))+o[10]-1094730640)<<23|e>>>9)+r<<0,e=((e+=((i=(s=((s+=((n=e^r)^(t=((t+=(n^s)+o[13]+681279174)<<4|t>>>28)+e<<0))+o[0]-358537222)<<11|s>>>21)+t<<0)^t)^(r=((r+=(i^e)+o[3]-722521979)<<16|r>>>16)+s<<0))+o[6]+76029189)<<23|e>>>9)+r<<0,e=((e+=((i=(s=((s+=((n=e^r)^(t=((t+=(n^s)+o[9]-640364487)<<4|t>>>28)+e<<0))+o[12]-421815835)<<11|s>>>21)+t<<0)^t)^(r=((r+=(i^e)+o[15]+530742520)<<16|r>>>16)+s<<0))+o[2]-995338651)<<23|e>>>9)+r<<0,e=((e+=((s=((s+=(e^((t=((t+=(r^(e|~s))+o[0]-198630844)<<6|t>>>26)+e<<0)|~r))+o[7]+1126891415)<<10|s>>>22)+t<<0)^((r=((r+=(t^(s|~e))+o[14]-1416354905)<<15|r>>>17)+s<<0)|~t))+o[5]-57434055)<<21|e>>>11)+r<<0,e=((e+=((s=((s+=(e^((t=((t+=(r^(e|~s))+o[12]+1700485571)<<6|t>>>26)+e<<0)|~r))+o[3]-1894986606)<<10|s>>>22)+t<<0)^((r=((r+=(t^(s|~e))+o[10]-1051523)<<15|r>>>17)+s<<0)|~t))+o[1]-2054922799)<<21|e>>>11)+r<<0,e=((e+=((s=((s+=(e^((t=((t+=(r^(e|~s))+o[8]+1873313359)<<6|t>>>26)+e<<0)|~r))+o[15]-30611744)<<10|s>>>22)+t<<0)^((r=((r+=(t^(s|~e))+o[6]-1560198380)<<15|r>>>17)+s<<0)|~t))+o[13]+1309151649)<<21|e>>>11)+r<<0,e=((e+=((s=((s+=(e^((t=((t+=(r^(e|~s))+o[4]-145523070)<<6|t>>>26)+e<<0)|~r))+o[11]-1120210379)<<10|s>>>22)+t<<0)^((r=((r+=(t^(s|~e))+o[2]+718787259)<<15|r>>>17)+s<<0)|~t))+o[9]-343485551)<<21|e>>>11)+r<<0,this.first?(this.h0=t+1732584193<<0,this.h1=e-271733879<<0,this.h2=r-1732584194<<0,this.h3=s+271733878<<0,this.first=!1):(this.h0=this.h0+t<<0,this.h1=this.h1+e<<0,this.h2=this.h2+r<<0,this.h3=this.h3+s<<0)},D.prototype.hex=function(){this.finalize();var t=this.h0,e=this.h1,r=this.h2,s=this.h3;return h[t>>>4&15]+h[15&t]+h[t>>>12&15]+h[t>>>8&15]+h[t>>>20&15]+h[t>>>16&15]+h[t>>>28&15]+h[t>>>24&15]+h[e>>>4&15]+h[15&e]+h[e>>>12&15]+h[e>>>8&15]+h[e>>>20&15]+h[e>>>16&15]+h[e>>>28&15]+h[e>>>24&15]+h[r>>>4&15]+h[15&r]+h[r>>>12&15]+h[r>>>8&15]+h[r>>>20&15]+h[r>>>16&15]+h[r>>>28&15]+h[r>>>24&15]+h[s>>>4&15]+h[15&s]+h[s>>>12&15]+h[s>>>8&15]+h[s>>>20&15]+h[s>>>16&15]+h[s>>>28&15]+h[s>>>24&15]},D.prototype.toString=D.prototype.hex,D.prototype.digest=function(){this.finalize();var t=this.h0,e=this.h1,r=this.h2,s=this.h3;return[255&t,t>>>8&255,t>>>16&255,t>>>24&255,255&e,e>>>8&255,e>>>16&255,e>>>24&255,255&r,r>>>8&255,r>>>16&255,r>>>24&255,255&s,s>>>8&255,s>>>16&255,s>>>24&255]},D.prototype.array=D.prototype.digest,D.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(16),e=new Uint32Array(t);return e[0]=this.h0,e[1]=this.h1,e[2]=this.h2,e[3]=this.h3,t},D.prototype.buffer=D.prototype.arrayBuffer,D.prototype.base64=function(){for(var t,e,r,s="",n=this.array(),i=0;i<15;)t=n[i++],e=n[i++],r=n[i++],s+=g[t>>>2]+g[63&(t<<4|e>>>4)]+g[63&(e<<2|r>>>6)]+g[63&r];return t=n[i],s+=g[t>>>2]+g[t<<4&63]+"=="},O.prototype=new D,O.prototype.finalize=function(){if(D.prototype.finalize.call(this),this.inner){this.inner=!1;var t=this.array();D.call(this,this.sharedMemory),this.update(this.oKeyPad),this.update(t),D.prototype.finalize.call(this)}};var b=function(){var t=$("hex");o&&(t=A(t)),t.create=function(){return new D},t.update=function(e){return t.create().update(e)};for(var e=0;e<y.length;++e){var r=y[e];t[r]=$(r)}return t}();b.md5=b,b.md5.hmac=function(){var t=I("hex");t.create=function(t){return new O(t)},t.update=function(e,r){return t.create(e).update(r)};for(var e=0;e<y.length;++e){var r=y[e];t[r]=I(r)}return t}(),c?l.exports=b:r.md5=b}();var f=h.exports;function p(t){let e,r=t[0],s=1;for(;s<t.length;){const n=t[s],i=t[s+1];if(s+=2,("optionalAccess"===n||"optionalCall"===n)&&null==r)return;"access"===n||"optionalAccess"===n?(e=r,r=i(r)):"call"!==n&&"optionalCall"!==n||(r=i(((...t)=>r.call(e,...t))),e=void 0)}return r}class y{__init(){this.studentList=[]}__init2(){this.codeStart=0}__init3(){this.classid=0}constructor(t){y.prototype.__init.call(this),y.prototype.__init2.call(this),y.prototype.__init3.call(this);const e=t%100,r=Math.floor(t/100)%100;this.classid=t;const s={9:{schoolId:39,classId:1},10:{schoolId:39,classId:2},11:{schoolId:9,classId:9},12:{schoolId:9,classId:10}};if(Object.entries(s).map((t=>t[0].toString())).includes(e.toString())){const t=s[e];this.codeStart=1e4*t.schoolId+100*r+t.classId}else{const t=e%100;this.codeStart=t<10?9e4+100*r+e:39e4+100*r+e%10}}appendUser(t){this.studentList.push(t),console.log("Stored user with id",t.id,"in _id",t._id,"into class",this.classid)}removeUser(t){this.studentList=this.studentList.filter((e=>e._id!==t))}getUserCode(t){const e=this.studentList.findIndex((e=>e._id===t));return 100*this.codeStart+e+1}getUser(t){return console.log("Getting user",t,"from class",this.classid,this.studentList.find((e=>e._id===t)),"in",this.studentList),this.studentList.find((e=>e._id===t))}}class g{__init4(){this.classList=[]}constructor(){g.prototype.__init4.call(this);for(let t=2022;t<=2023;t++)for(let e=1;e<=17;e++)this.classList.push(new y(100*t+e))}appendUser(t){console.log("Append user",t.id,"into class",Math.floor(t.id/100));const e=this.classList.findIndex((e=>e.classid===Math.floor(t.id/100)));-1!==e&&this.classList[e].appendUser(t)}removeUser(t,e){p([this.classList.find((t=>t.classid===e)),"optionalAccess",t=>t.removeUser,"call",e=>e(t)])}getUserCode(t,e){const r=this.classList.findIndex((t=>t.classid===e));if(-1!==r)return this.classList[r].getUserCode(t)}studentExchange(t){const e=Math.floor(t.previous/100),r=t.toClass,s=this.classList.find((t=>t.classid===e)),n=this.classList.find((t=>t.classid===r));if(console.log(s,n,s&&n),s&&n){const i=s.getUser(t._id);console.log(i,"old 114514",t._id,e,r),i&&(s.removeUser(t._id),n.appendUser(i),console.log("Student",t._id,"exchanged from",e,"to",r,"with new code",this.getUserCode(t._id,r)))}}getClassStudentList(t,e){return p([this.classList.find((r=>r.classid===100*t+e)),"optionalAccess",t=>t.studentList])}}function v(t){let e,r=t[0],s=1;for(;s<t.length;){const n=t[s],i=t[s+1];if(s+=2,("optionalAccess"===n||"optionalCall"===n)&&null==r)return;"access"===n||"optionalAccess"===n?(e=r,r=i(r)):"call"!==n&&"optionalCall"!==n||(r=i(((...t)=>r.call(e,...t))),e=void 0)}return r}const S=new g;function m(t){const e=1&t,r=2&t,s=4&t,n=8&t,i=16&t,o=32&t,a=["student","secretary","department","auditor","inspector","admin","system"].filter(((t,a)=>[true,e,r,s,n,i,o][a]));return console.log("User",t,"has position",a),a}function _(t){return t.map((t=>function(t){const e={_id:new s.ObjectId,id:t.userid,name:t.username,sex:"unknown",position:m(t.permission),code:100*t.classid+t.userid%100};if(t.userid>20219999){S.appendUser({id:e.id,_id:e._id.toString(),name:e.name});const t=S.getUserCode(e._id.toString(),Math.floor(e.id/100));t&&(e.code=t)}return console.log("Transformed user",t.userid,"with code",e.code),e}(t))).map((t=>function(t){return{...t,password:f.md5(t.id.toString())}}(t)))}function w(t){const n=r.readFileSync(e.resolve("data","handler","user-transformed.json"),"utf-8"),i=v([JSON.parse(n),"access",t=>t.find,"call",e=>e((e=>e.id===t)),"optionalAccess",t=>t._id]);if(i)return console.log("Found user",t,"with id",i),new s.ObjectId(i);throw new Error("User not found")}function $(t){return t.filter((t=>!t.userid.toString().startsWith(t.classid.toString()))).map((t=>{S.studentExchange({_id:w(t.userid).toString(),toClass:t.classid,previous:t.userid});const e={_id:w(t.userid),id:t.userid,name:t.username,code:S.getUserCode(w(t.userid).toString(),t.classid)};if(t.userid>20229999&&e.code){const r=e.code%100;e.id=100*t.classid+r}return e}))}function A(){return v([S,"access",t=>t.getClassStudentList,"call",t=>t(2023,2),"optionalAccess",t=>t.map,"call",t=>t((t=>{const e=(r=S.getUserCode(t._id,202302),s=()=>0,null!=r?r:s());var r,s;return{_id:t._id,id:20230200+e%100,name:t.name,code:e}})),"access",t=>t.sort,"call",t=>t(((t,e)=>t.code-e.code))])}function I(){const t=r.readFileSync(e.resolve("data","handler","user-transformed.json"),"utf-8"),s=r.readFileSync(e.resolve("data","handler","mappings.json"),"utf-8"),n=function(t,e){return t.map((t=>{if(t.id>20219999){const r=e.find((e=>e._id===t._id.toString()));return r?(console.log(r,"map"),{...t,id:r.id,code:r.code}):t}return t}))}(JSON.parse(t),JSON.parse(s));r.writeFileSync(e.resolve("data","handler","user-transformed-mapped.json"),JSON.stringify(n,null,2))}var D,O,b,M;!function(t){t[t.UNAUDITED=1]="UNAUDITED";t[t.ACCEPTED=2]="ACCEPTED";t[t.REJECTED=3]="REJECTED";t[t.SPECIAL=4]="SPECIAL"}(D||(D={})),function(t){t[t.WAITING_FOR_SIGNUP_AUDIT=1]="WAITING_FOR_SIGNUP_AUDIT";t[t.DRAFT=2]="DRAFT";t[t.WAITING_FOR_FIRST_AUDIT=3]="WAITING_FOR_FIRST_AUDIT";t[t.WAITING_FOR_FINAL_AUDIT=4]="WAITING_FOR_FINAL_AUDIT";t[t.ACCEPTED=5]="ACCEPTED";t[t.REJECTED=6]="REJECTED";t[t.SPIKE=7]="SPIKE"}(O||(O={})),function(t){t[t.INSIDE=1]="INSIDE";t[t.OUTSIDE=2]="OUTSIDE";t[t.LARGE=3]="LARGE"}(b||(b={})),function(t){t[t.INSIDE=1]="INSIDE";t[t.APPOINTED=2]="APPOINTED";t[t.SPECIAL=3]="SPECIAL"}(M||(M={}));const E=["","pending","effective","refused","effective"],N=["","specified","social","scale","special"],U=["","draft","draft","pending","pending","effective","refused","rejected"];var C={exports:{}},T=d(C.exports=function(){var t=1e3,e=6e4,r=36e5,s="millisecond",n="second",i="minute",o="hour",a="day",c="week",u="month",d="quarter",l="year",h="date",f="Invalid Date",p=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,y=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,g={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(t){var e=["th","st","nd","rd"],r=t%100;return"["+t+(e[(r-20)%10]||e[r]||e[0])+"]"}},v=function(t,e,r){var s=String(t);return!s||s.length>=e?t:""+Array(e+1-s.length).join(r)+t},S={s:v,z:function(t){var e=-t.utcOffset(),r=Math.abs(e),s=Math.floor(r/60),n=r%60;return(e<=0?"+":"-")+v(s,2,"0")+":"+v(n,2,"0")},m:function t(e,r){if(e.date()<r.date())return-t(r,e);var s=12*(r.year()-e.year())+(r.month()-e.month()),n=e.clone().add(s,u),i=r-n<0,o=e.clone().add(s+(i?-1:1),u);return+(-(s+(r-n)/(i?n-o:o-n))||0)},a:function(t){return t<0?Math.ceil(t)||0:Math.floor(t)},p:function(t){return{M:u,y:l,w:c,d:a,D:h,h:o,m:i,s:n,ms:s,Q:d}[t]||String(t||"").toLowerCase().replace(/s$/,"")},u:function(t){return void 0===t}},m="en",_={};_[m]=g;var w="$isDayjsObject",$=function(t){return t instanceof O||!(!t||!t[w])},A=function t(e,r,s){var n;if(!e)return m;if("string"==typeof e){var i=e.toLowerCase();_[i]&&(n=i),r&&(_[i]=r,n=i);var o=e.split("-");if(!n&&o.length>1)return t(o[0])}else{var a=e.name;_[a]=e,n=a}return!s&&n&&(m=n),n||!s&&m},I=function(t,e){if($(t))return t.clone();var r="object"==typeof e?e:{};return r.date=t,r.args=arguments,new O(r)},D=S;D.l=A,D.i=$,D.w=function(t,e){return I(t,{locale:e.$L,utc:e.$u,x:e.$x,$offset:e.$offset})};var O=function(){function g(t){this.$L=A(t.locale,null,!0),this.parse(t),this.$x=this.$x||t.x||{},this[w]=!0}var v=g.prototype;return v.parse=function(t){this.$d=function(t){var e=t.date,r=t.utc;if(null===e)return new Date(NaN);if(D.u(e))return new Date;if(e instanceof Date)return new Date(e);if("string"==typeof e&&!/Z$/i.test(e)){var s=e.match(p);if(s){var n=s[2]-1||0,i=(s[7]||"0").substring(0,3);return r?new Date(Date.UTC(s[1],n,s[3]||1,s[4]||0,s[5]||0,s[6]||0,i)):new Date(s[1],n,s[3]||1,s[4]||0,s[5]||0,s[6]||0,i)}}return new Date(e)}(t),this.init()},v.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},v.$utils=function(){return D},v.isValid=function(){return!(this.$d.toString()===f)},v.isSame=function(t,e){var r=I(t);return this.startOf(e)<=r&&r<=this.endOf(e)},v.isAfter=function(t,e){return I(t)<this.startOf(e)},v.isBefore=function(t,e){return this.endOf(e)<I(t)},v.$g=function(t,e,r){return D.u(t)?this[e]:this.set(r,t)},v.unix=function(){return Math.floor(this.valueOf()/1e3)},v.valueOf=function(){return this.$d.getTime()},v.startOf=function(t,e){var r=this,s=!!D.u(e)||e,d=D.p(t),f=function(t,e){var n=D.w(r.$u?Date.UTC(r.$y,e,t):new Date(r.$y,e,t),r);return s?n:n.endOf(a)},p=function(t,e){return D.w(r.toDate()[t].apply(r.toDate("s"),(s?[0,0,0,0]:[23,59,59,999]).slice(e)),r)},y=this.$W,g=this.$M,v=this.$D,S="set"+(this.$u?"UTC":"");switch(d){case l:return s?f(1,0):f(31,11);case u:return s?f(1,g):f(0,g+1);case c:var m=this.$locale().weekStart||0,_=(y<m?y+7:y)-m;return f(s?v-_:v+(6-_),g);case a:case h:return p(S+"Hours",0);case o:return p(S+"Minutes",1);case i:return p(S+"Seconds",2);case n:return p(S+"Milliseconds",3);default:return this.clone()}},v.endOf=function(t){return this.startOf(t,!1)},v.$set=function(t,e){var r,c=D.p(t),d="set"+(this.$u?"UTC":""),f=(r={},r[a]=d+"Date",r[h]=d+"Date",r[u]=d+"Month",r[l]=d+"FullYear",r[o]=d+"Hours",r[i]=d+"Minutes",r[n]=d+"Seconds",r[s]=d+"Milliseconds",r)[c],p=c===a?this.$D+(e-this.$W):e;if(c===u||c===l){var y=this.clone().set(h,1);y.$d[f](p),y.init(),this.$d=y.set(h,Math.min(this.$D,y.daysInMonth())).$d}else f&&this.$d[f](p);return this.init(),this},v.set=function(t,e){return this.clone().$set(t,e)},v.get=function(t){return this[D.p(t)]()},v.add=function(s,d){var h,f=this;s=Number(s);var p=D.p(d),y=function(t){var e=I(f);return D.w(e.date(e.date()+Math.round(t*s)),f)};if(p===u)return this.set(u,this.$M+s);if(p===l)return this.set(l,this.$y+s);if(p===a)return y(1);if(p===c)return y(7);var g=(h={},h[i]=e,h[o]=r,h[n]=t,h)[p]||1,v=this.$d.getTime()+s*g;return D.w(v,this)},v.subtract=function(t,e){return this.add(-1*t,e)},v.format=function(t){var e=this,r=this.$locale();if(!this.isValid())return r.invalidDate||f;var s=t||"YYYY-MM-DDTHH:mm:ssZ",n=D.z(this),i=this.$H,o=this.$m,a=this.$M,c=r.weekdays,u=r.months,d=r.meridiem,l=function(t,r,n,i){return t&&(t[r]||t(e,s))||n[r].slice(0,i)},h=function(t){return D.s(i%12||12,t,"0")},p=d||function(t,e,r){var s=t<12?"AM":"PM";return r?s.toLowerCase():s};return s.replace(y,(function(t,s){return s||function(t){switch(t){case"YY":return String(e.$y).slice(-2);case"YYYY":return D.s(e.$y,4,"0");case"M":return a+1;case"MM":return D.s(a+1,2,"0");case"MMM":return l(r.monthsShort,a,u,3);case"MMMM":return l(u,a);case"D":return e.$D;case"DD":return D.s(e.$D,2,"0");case"d":return String(e.$W);case"dd":return l(r.weekdaysMin,e.$W,c,2);case"ddd":return l(r.weekdaysShort,e.$W,c,3);case"dddd":return c[e.$W];case"H":return String(i);case"HH":return D.s(i,2,"0");case"h":return h(1);case"hh":return h(2);case"a":return p(i,o,!0);case"A":return p(i,o,!1);case"m":return String(o);case"mm":return D.s(o,2,"0");case"s":return String(e.$s);case"ss":return D.s(e.$s,2,"0");case"SSS":return D.s(e.$ms,3,"0");case"Z":return n}return null}(t)||n.replace(":","")}))},v.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},v.diff=function(s,h,f){var p,y=this,g=D.p(h),v=I(s),S=(v.utcOffset()-this.utcOffset())*e,m=this-v,_=function(){return D.m(y,v)};switch(g){case l:p=_()/12;break;case u:p=_();break;case d:p=_()/3;break;case c:p=(m-S)/6048e5;break;case a:p=(m-S)/864e5;break;case o:p=m/r;break;case i:p=m/e;break;case n:p=m/t;break;default:p=m}return f?p:D.a(p)},v.daysInMonth=function(){return this.endOf(u).$D},v.$locale=function(){return _[this.$L]},v.locale=function(t,e){if(!t)return this.$L;var r=this.clone(),s=A(t,e,!0);return s&&(r.$L=s),r},v.clone=function(){return D.w(this.$d,this)},v.toDate=function(){return new Date(this.valueOf())},v.toJSON=function(){return this.isValid()?this.toISOString():null},v.toISOString=function(){return this.$d.toISOString()},v.toString=function(){return this.$d.toUTCString()},g}(),b=O.prototype;return I.prototype=b,[["$ms",s],["$s",n],["$m",i],["$H",o],["$W",a],["$M",u],["$y",l],["$D",h]].forEach((function(t){b[t[1]]=function(e){return this.$g(e,t[0],t[1])}})),I.extend=function(t,e){return t.$i||(t(e,O,I),t.$i=!0),I},I.locale=A,I.isDayjs=$,I.unix=function(t){return I(1e3*t)},I.en=_[m],I.Ls=_,I.p={},I}());function x(t){return t.map((t=>{console.log("Transforming activity",t.id,"with status",t.status);const e=function(t){return E[t]}(t.status),r=function(t,e){return e===D.SPECIAL?"special":N[t]}(t.type,t.status),n={_id:new s.ObjectId,type:r,name:t.name,description:t.description,members:[],duration:t.reward/60,date:T(t.time).toISOString(),createdAt:T().toISOString(),updatedAt:T().toISOString(),creator:w(t.holder).toString(),status:e,oid:t.id},i={place:"可莉不知道哦",deadline:T(t.time).toISOString(),classes:[]};return"specified"===n.type?(console.log("It is a specified activity."),{...n,registration:i}):n}))}function F(t,e,r=[]){const s=function(t){return U[t]}(t.status);return console.log("Transforming member",t.userid,"with status",s),{_id:w(t.userid).toString(),status:s,impression:t.thought,duration:(n=t.reward/60,i=()=>e,null!=n?n:i()),history:[],images:r};var n,i}function L(){const t=r.readFileSync(e.resolve("data","export","volunteer.json"),"utf-8"),s=JSON.parse(t),n=r.readFileSync(e.resolve("data","export","user_vol.json"),"utf-8"),i=JSON.parse(n),o=r.readFileSync(e.resolve("data","export","picture.json"),"utf-8"),a=JSON.parse(o),c=r.readFileSync(e.resolve("data","export","class_vol.json"),"utf-8"),u=JSON.parse(c),d=function(t,e,r=[],s=[]){return e.map((e=>{const s=t.findIndex((t=>t.oid===e.volid));if(s){console.log("Appending member",e.userid,"into activity",s);const n=t[s],i=r.filter((t=>t.volid===e.volid&&t.userid===e.userid)).map((t=>t.filename));n.members.push(F(e,n.duration,i))}})),t.map((t=>{const e=s.filter((e=>e.volid===t.oid));return console.log("Appending classes",e.map((t=>t.classid)),"into activity",t.oid),0!==e.length&&"specified"===t.type?{...t,registration:{...t.registration,classes:e.map((t=>({class:t.classid,min:0,max:t.max})))}}:t})).filter((t=>0!==t.members.length&&!t.description.includes(".ignore")&&!t.description.includes("测试")&&!t.name.includes("测试")))}(x(s),i,a,u);r.writeFileSync(e.resolve("data","handler","activity-transformed.json"),JSON.stringify(d,null,2))}!async function(){console.time("export"),await c(),function(){const t=r.readFileSync(e.resolve("data","export","user.json"),"utf-8"),s=JSON.parse(t),n=_(s);r.writeFileSync(e.resolve("data","handler","user-transformed.json"),JSON.stringify(n,null,2));const i=[$(s),A()].flat(1);r.writeFileSync(e.resolve("data","handler","mappings.json"),JSON.stringify(i.filter((t=>v([t,"optionalAccess",t=>t.code])&&t)),null,2)),r.writeFileSync(e.resolve("data","handler","classid-changed.json"),JSON.stringify($(s),null,2)),r.writeFileSync(e.resolve("data","handler","class2-2023.json"),JSON.stringify(A(),null,2))}(),L(),I(),console.timeEnd("export")}();
