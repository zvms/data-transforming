"use strict";var e=require("sqlite3"),t=require("path"),s=require("fs"),n=require("mongodb"),i=require("fs/promises"),r=require("bcrypt");const o=["volunteer","user","class","class_vol","user_vol","picture","issue","notice","user_notice","class_notice"];function a(e){const t=o.map((t=>new Promise(((s,n)=>{e.all(`SELECT * FROM ${t}`,((e,i)=>{e&&n(e),s({key:t,value:i})}))}))));return Promise.all(t)}async function c(){const n=function(){const s=t.resolve("database","zvms.db");return new e.Database(s)}(),i=t.resolve("data","export");(await a(n)).forEach((e=>{console.log("Exporting table",e.key),s.writeFileSync(t.resolve(i,e.key+".json"),JSON.stringify(e.value,null,2))}))}function l(e){let t,s=e[0],n=1;for(;n<e.length;){const i=e[n],r=e[n+1];if(n+=2,("optionalAccess"===i||"optionalCall"===i)&&null==s)return;"access"===i||"optionalAccess"===i?(t=s,s=r(s)):"call"!==i&&"optionalCall"!==i||(s=r(((...e)=>s.call(t,...e))),t=void 0)}return s}class d{__init(){this.studentList=[]}__init2(){this.codeStart=0}__init3(){this.classid=0}constructor(e){d.prototype.__init.call(this),d.prototype.__init2.call(this),d.prototype.__init3.call(this);const t=e%100,s=Math.floor(e/100)%100;this.classid=e;const n={9:{schoolId:39,classId:1},10:{schoolId:39,classId:2},11:{schoolId:9,classId:9},12:{schoolId:9,classId:10}};if(Object.entries(n).map((e=>e[0].toString())).includes(t.toString())){const e=n[t];this.codeStart=1e4*e.schoolId+100*s+e.classId}else{const e=t%100;this.codeStart=e<10?9e4+100*s+t:39e4+100*s+t%10}}appendUser(e){this.studentList.push(e),console.log("Stored user with id",e.id,"in _id",e._id,"into class",this.classid)}removeUser(e){this.studentList=this.studentList.filter((t=>t._id!==e))}getUserCode(e){const t=this.studentList.findIndex((t=>t._id===e));return 100*this.codeStart+t+1}getUser(e){return this.studentList.find((t=>t._id===e))}}class u{__init4(){this.classList=[]}constructor(){u.prototype.__init4.call(this);for(let e=2022;e<=2023;e++)for(let t=1;t<=17;t++)this.classList.push(new d(100*e+t))}appendUser(e){console.log("Append user",e.id,"into class",Math.floor(e.id/100));const t=this.classList.findIndex((t=>t.classid===Math.floor(e.id/100)));-1!==t&&this.classList[t].appendUser(e)}removeUser(e,t){l([this.classList.find((e=>e.classid===t)),"optionalAccess",e=>e.removeUser,"call",t=>t(e)])}getUserCode(e,t){const s=this.classList.findIndex((e=>e.classid===t));if(-1!==s)return this.classList[s].getUserCode(e)}studentExchange(e){const t=Math.floor(e.previous/100),s=e.toClass,n=this.classList.find((e=>e.classid===t)),i=this.classList.find((e=>e.classid===s));if(n&&i){const r=n.getUser(e._id);r&&(n.removeUser(e._id),i.appendUser(r),console.log("Student",e._id,"exchanged from",t,"to",s,"with new code",this.getUserCode(e._id,s)))}}getClassStudentList(e,t){return l([this.classList.find((s=>s.classid===100*e+t)),"optionalAccess",e=>e.studentList])}getClassWithCode(e){return l([this.classList.find((t=>t.codeStart===Math.floor(e/100))),"optionalAccess",e=>e.classid])}}const f=[];function p(e){if(4!==e.length)return e;const t=e.slice(0,2),s=e.slice(3);return`${t} ${{"一":"1","二":"2","三":"3","四":"4","五":"5","六":"6","七":"7","八":"8","九":"9","十":"10"}[e.slice(2,3)]} ${s}`}function h(e){const t=function(e){const t=!0,s=1&e,n=2&e,i=4&e,r=8&e,o=16&e,a=32&e,c=["student","secretary","department","auditor","inspector","admin","system"].filter(((e,c)=>[t,s,n,i,r,o,a][c]));return c}(e.permission),s=t.map((e=>f.find((t=>"class"!==t.type&&t.permissions.includes(e))))).filter((e=>void 0!==e)),n=f.find((t=>t.description===e.classid.toString()));n&&s.push(n);const i=new Set(s.map((e=>e._id)));return Array.from(i)}function m(e){const t=f.filter((t=>e.includes(t._id)));if(t)return t[0].description}function g(e,t){return null!=e?e:t()}function S(e){let t,s=e[0],n=1;for(;n<e.length;){const i=e[n],r=e[n+1];if(n+=2,("optionalAccess"===i||"optionalCall"===i)&&null==s)return;"access"===i||"optionalAccess"===i?(t=s,s=r(s)):"call"!==i&&"optionalCall"!==i||(s=r(((...e)=>s.call(t,...e))),t=void 0)}return s}const y=JSON.parse(s.readFileSync(t.resolve("database","user_id.json")).toString()),v=new u;function _(e){return e.map((e=>function(e){const t={_id:(new n.ObjectId).toString(),id:e.userid,name:e.username,sex:"unknown",group:h(e)};return console.log("Transformed user",e.userid,"with id",t._id),t}(e)))}const w=[];function $(e){if(0===w.length){const e=s.readFileSync(t.resolve("data","handler","user-transformed.json"),"utf-8");w.push(...JSON.parse(e))}const i=S([w,"access",e=>e.find,"call",t=>t((t=>t.id===e)),"optionalAccess",e=>e._id]);if(i)return console.log("Found user",e,"with id",i),new n.ObjectId(i);throw new Error("User not found")}function I(e){return e.filter((e=>!e.userid.toString().startsWith(e.classid.toString()))).map((e=>{v.studentExchange({_id:$(e.userid).toString(),toClass:e.classid,previous:e.userid});const t={_id:$(e.userid),id:e.userid,name:e.username,code:v.getUserCode($(e.userid).toString(),e.classid)};if(e.userid>20229999&&t.code){const s=t.code%100;t.id=100*e.classid+s}return t}))}function O(){return S([v,"access",e=>e.getClassStudentList,"call",e=>e(2023,2),"optionalAccess",e=>e.map,"call",e=>e((e=>{const t=g(v.getUserCode(e._id,202302),(()=>0));return{_id:e._id,id:20230200+t%100,name:e.name,code:t}})),"access",e=>e.sort,"call",e=>e(((e,t)=>e.code-t.code))])}var D,A,b,M;!function(e){e[e.UNAUDITED=1]="UNAUDITED";e[e.ACCEPTED=2]="ACCEPTED";e[e.REJECTED=3]="REJECTED";e[e.SPECIAL=4]="SPECIAL"}(D||(D={})),function(e){e[e.WAITING_FOR_SIGNUP_AUDIT=1]="WAITING_FOR_SIGNUP_AUDIT";e[e.DRAFT=2]="DRAFT";e[e.WAITING_FOR_FIRST_AUDIT=3]="WAITING_FOR_FIRST_AUDIT";e[e.WAITING_FOR_FINAL_AUDIT=4]="WAITING_FOR_FINAL_AUDIT";e[e.ACCEPTED=5]="ACCEPTED";e[e.REJECTED=6]="REJECTED";e[e.SPIKE=7]="SPIKE"}(A||(A={})),function(e){e[e.INSIDE=1]="INSIDE";e[e.OUTSIDE=2]="OUTSIDE";e[e.LARGE=3]="LARGE"}(b||(b={})),function(e){e[e.INSIDE=1]="INSIDE";e[e.APPOINTED=2]="APPOINTED";e[e.SPECIAL=3]="SPECIAL"}(M||(M={}));const N=["","pending","effective","refused","effective"],j=["","specified","social","scale","special"],E=["","on-campus","off-campus","social-practice"],T=["","draft","draft","pending","pending","effective","refused","rejected"];function C(e){return T[e]}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function F(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var x={exports:{}},L=F(x.exports=function(){var e=1e3,t=6e4,s=36e5,n="millisecond",i="second",r="minute",o="hour",a="day",c="week",l="month",d="quarter",u="year",f="date",p="Invalid Date",h=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,m=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,g={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(e){var t=["th","st","nd","rd"],s=e%100;return"["+e+(t[(s-20)%10]||t[s]||t[0])+"]"}},S=function(e,t,s){var n=String(e);return!n||n.length>=t?e:""+Array(t+1-n.length).join(s)+e},y={s:S,z:function(e){var t=-e.utcOffset(),s=Math.abs(t),n=Math.floor(s/60),i=s%60;return(t<=0?"+":"-")+S(n,2,"0")+":"+S(i,2,"0")},m:function e(t,s){if(t.date()<s.date())return-e(s,t);var n=12*(s.year()-t.year())+(s.month()-t.month()),i=t.clone().add(n,l),r=s-i<0,o=t.clone().add(n+(r?-1:1),l);return+(-(n+(s-i)/(r?i-o:o-i))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(e){return{M:l,y:u,w:c,d:a,D:f,h:o,m:r,s:i,ms:n,Q:d}[e]||String(e||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}},v="en",_={};_[v]=g;var w="$isDayjsObject",$=function(e){return e instanceof A||!(!e||!e[w])},I=function e(t,s,n){var i;if(!t)return v;if("string"==typeof t){var r=t.toLowerCase();_[r]&&(i=r),s&&(_[r]=s,i=r);var o=t.split("-");if(!i&&o.length>1)return e(o[0])}else{var a=t.name;_[a]=t,i=a}return!n&&i&&(v=i),i||!n&&v},O=function(e,t){if($(e))return e.clone();var s="object"==typeof t?t:{};return s.date=e,s.args=arguments,new A(s)},D=y;D.l=I,D.i=$,D.w=function(e,t){return O(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})};var A=function(){function g(e){this.$L=I(e.locale,null,!0),this.parse(e),this.$x=this.$x||e.x||{},this[w]=!0}var S=g.prototype;return S.parse=function(e){this.$d=function(e){var t=e.date,s=e.utc;if(null===t)return new Date(NaN);if(D.u(t))return new Date;if(t instanceof Date)return new Date(t);if("string"==typeof t&&!/Z$/i.test(t)){var n=t.match(h);if(n){var i=n[2]-1||0,r=(n[7]||"0").substring(0,3);return s?new Date(Date.UTC(n[1],i,n[3]||1,n[4]||0,n[5]||0,n[6]||0,r)):new Date(n[1],i,n[3]||1,n[4]||0,n[5]||0,n[6]||0,r)}}return new Date(t)}(e),this.init()},S.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},S.$utils=function(){return D},S.isValid=function(){return!(this.$d.toString()===p)},S.isSame=function(e,t){var s=O(e);return this.startOf(t)<=s&&s<=this.endOf(t)},S.isAfter=function(e,t){return O(e)<this.startOf(t)},S.isBefore=function(e,t){return this.endOf(t)<O(e)},S.$g=function(e,t,s){return D.u(e)?this[t]:this.set(s,e)},S.unix=function(){return Math.floor(this.valueOf()/1e3)},S.valueOf=function(){return this.$d.getTime()},S.startOf=function(e,t){var s=this,n=!!D.u(t)||t,d=D.p(e),p=function(e,t){var i=D.w(s.$u?Date.UTC(s.$y,t,e):new Date(s.$y,t,e),s);return n?i:i.endOf(a)},h=function(e,t){return D.w(s.toDate()[e].apply(s.toDate("s"),(n?[0,0,0,0]:[23,59,59,999]).slice(t)),s)},m=this.$W,g=this.$M,S=this.$D,y="set"+(this.$u?"UTC":"");switch(d){case u:return n?p(1,0):p(31,11);case l:return n?p(1,g):p(0,g+1);case c:var v=this.$locale().weekStart||0,_=(m<v?m+7:m)-v;return p(n?S-_:S+(6-_),g);case a:case f:return h(y+"Hours",0);case o:return h(y+"Minutes",1);case r:return h(y+"Seconds",2);case i:return h(y+"Milliseconds",3);default:return this.clone()}},S.endOf=function(e){return this.startOf(e,!1)},S.$set=function(e,t){var s,c=D.p(e),d="set"+(this.$u?"UTC":""),p=(s={},s[a]=d+"Date",s[f]=d+"Date",s[l]=d+"Month",s[u]=d+"FullYear",s[o]=d+"Hours",s[r]=d+"Minutes",s[i]=d+"Seconds",s[n]=d+"Milliseconds",s)[c],h=c===a?this.$D+(t-this.$W):t;if(c===l||c===u){var m=this.clone().set(f,1);m.$d[p](h),m.init(),this.$d=m.set(f,Math.min(this.$D,m.daysInMonth())).$d}else p&&this.$d[p](h);return this.init(),this},S.set=function(e,t){return this.clone().$set(e,t)},S.get=function(e){return this[D.p(e)]()},S.add=function(n,d){var f,p=this;n=Number(n);var h=D.p(d),m=function(e){var t=O(p);return D.w(t.date(t.date()+Math.round(e*n)),p)};if(h===l)return this.set(l,this.$M+n);if(h===u)return this.set(u,this.$y+n);if(h===a)return m(1);if(h===c)return m(7);var g=(f={},f[r]=t,f[o]=s,f[i]=e,f)[h]||1,S=this.$d.getTime()+n*g;return D.w(S,this)},S.subtract=function(e,t){return this.add(-1*e,t)},S.format=function(e){var t=this,s=this.$locale();if(!this.isValid())return s.invalidDate||p;var n=e||"YYYY-MM-DDTHH:mm:ssZ",i=D.z(this),r=this.$H,o=this.$m,a=this.$M,c=s.weekdays,l=s.months,d=s.meridiem,u=function(e,s,i,r){return e&&(e[s]||e(t,n))||i[s].slice(0,r)},f=function(e){return D.s(r%12||12,e,"0")},h=d||function(e,t,s){var n=e<12?"AM":"PM";return s?n.toLowerCase():n};return n.replace(m,(function(e,n){return n||function(e){switch(e){case"YY":return String(t.$y).slice(-2);case"YYYY":return D.s(t.$y,4,"0");case"M":return a+1;case"MM":return D.s(a+1,2,"0");case"MMM":return u(s.monthsShort,a,l,3);case"MMMM":return u(l,a);case"D":return t.$D;case"DD":return D.s(t.$D,2,"0");case"d":return String(t.$W);case"dd":return u(s.weekdaysMin,t.$W,c,2);case"ddd":return u(s.weekdaysShort,t.$W,c,3);case"dddd":return c[t.$W];case"H":return String(r);case"HH":return D.s(r,2,"0");case"h":return f(1);case"hh":return f(2);case"a":return h(r,o,!0);case"A":return h(r,o,!1);case"m":return String(o);case"mm":return D.s(o,2,"0");case"s":return String(t.$s);case"ss":return D.s(t.$s,2,"0");case"SSS":return D.s(t.$ms,3,"0");case"Z":return i}return null}(e)||i.replace(":","")}))},S.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},S.diff=function(n,f,p){var h,m=this,g=D.p(f),S=O(n),y=(S.utcOffset()-this.utcOffset())*t,v=this-S,_=function(){return D.m(m,S)};switch(g){case u:h=_()/12;break;case l:h=_();break;case d:h=_()/3;break;case c:h=(v-y)/6048e5;break;case a:h=(v-y)/864e5;break;case o:h=v/s;break;case r:h=v/t;break;case i:h=v/e;break;default:h=v}return p?h:D.a(h)},S.daysInMonth=function(){return this.endOf(l).$D},S.$locale=function(){return _[this.$L]},S.locale=function(e,t){if(!e)return this.$L;var s=this.clone(),n=I(e,t,!0);return n&&(s.$L=n),s},S.clone=function(){return D.w(this.$d,this)},S.toDate=function(){return new Date(this.valueOf())},S.toJSON=function(){return this.isValid()?this.toISOString():null},S.toISOString=function(){return this.$d.toISOString()},S.toString=function(){return this.$d.toUTCString()},g}(),b=A.prototype;return O.prototype=b,[["$ms",n],["$s",i],["$m",r],["$H",o],["$W",a],["$M",l],["$y",u],["$D",f]].forEach((function(e){b[e[1]]=function(t){return this.$g(t,e[0],e[1])}})),O.extend=function(e,t){return e.$i||(e(t,A,O),e.$i=!0),O},O.locale=I,O.isDayjs=$,O.unix=function(e){return O(1e3*e)},O.en=_[v],O.Ls=_,O.p={},O}());const U=new Map,J=[];function P(e){if(e.description.startsWith("append to #")){const t=e.description.replaceAll("\\n","\n").split("\n").map((e=>e.trim())),s=parseInt(t[0].split("#")[1]);if(isNaN(s))return e.id;function n(e){return-1!==J.findIndex((t=>t.id===e))}return n(s)?U.has(s)?U.get(s):(U.set(e.id,s),s):e.id}return e.id}function W(e){return e.map((e=>{console.log("Transforming activity",e.id,"with status",e.status);const t=function(e){return N[e]}(e.status),s=0===e.holder?"special":function(e,t,s=!1){return t===D.SPECIAL||s?"special":j[e]}(e.type,e.status),i={_id:(new n.ObjectId).toString(),type:s,name:e.name.replaceAll("（其他）","").replaceAll("（社团）","").replaceAll("（获奖）","").trim(),description:e.description.replaceAll("自提交义工：","").trim(),members:[],duration:e.reward/60,date:L(e.time).toISOString(),createdAt:L().toISOString(),updatedAt:L().toISOString(),creator:$(e.holder).toString(),status:t,oid:P(e),special:"special"===s?{classify:0===e.holder?"import":e.name.endsWith("（其他）")?"other":e.name.endsWith("（社团）")?"club":"other"}:void 0,registration:"specified"===s?{place:"地址未填写",deadline:L(e.time).toISOString(),classes:[]}:void 0},r={classify:0===e.holder?"import":e.name.endsWith("（其他）")?"other":e.name.endsWith("（社团）")?"club":"other"},o={place:"可莉不知道哦",deadline:L(e.time).toISOString(),duration:e.reward/60,classes:[]};return"specified"===i.type?(console.log("It is a specified activity."),{...i,registration:o}):"special"===i.type?(console.log("It is a special activity."),{...i,special:r}):i}))}function k(e,t,s,n=[]){const i=C(e.status);return console.log("Transforming member",e.userid,"with status",i),{_id:$(e.userid).toString(),status:i,mode:t,impression:e.thought,duration:(r=e.reward/60,o=()=>s,null!=r?r:o()),history:[],images:n};var r,o}function R(e){const t=J.findIndex((t=>t.id===e));return-1===t?"on-campus":(s=J[t].type,E[s]);var s}function Y(e,t,s=[],n=[]){return t.map((t=>{const n=(i=t.volid,console.log("Checking activity oid",i),U.has(i)?U.get(i):i);var i;const r=e.findIndex((e=>e.oid===n));if(r){console.log("Appending member",t.userid,"into activity",r);const n=e[r],i=s.filter((e=>e.volid===t.volid&&e.userid===t.userid)).map((e=>e.filename)),o=R(t.volid);if(console.log("Appending member",t.userid,"with mode",o),"special"===n.type)n.members.push(k(t,o,t.reward/60,i));else if(-1===n.members.findIndex((e=>e._id===$(t.userid).toString())))n.members.push(k(t,o,t.reward/60,i));else{console.log("Member",t.userid,"already exists in activity",r);const e=n.members.find((e=>e._id===$(t.userid).toString()));e&&(e.images=e.images.concat(i),e.duration+=t.reward/60,"effective"===e.status?e.impression+="\n"+t.thought:"refused"!==e.status&&"rejected"!==e.status||(e.impression=t.thought,e.status="effective"===C(t.status)?"effective":e.status))}}})),e.map((e=>{const t=n.filter((t=>t.volid===e.oid));return 0===t.length?console.log("No classes found for activity",e.oid):console.log("Appending classes",t.map((e=>e.classid)).join(", "),"into activity",e.oid),0!==t.length&&"specified"===e.type?{...e,registration:{...e.registration,classes:t.map((e=>({class:e.classid,min:0,max:e.max})))}}:e})).filter((e=>0!==e.members.length&&!e.description.includes(".ignore")&&!e.description.includes("测试")&&!e.name.includes("测试"))).map((e=>(delete e.oid,e)))}function H(){!function(){if(0===J.length){const e=s.readFileSync(t.resolve("data","export","volunteer.json"),"utf-8"),n=JSON.parse(e);J.push(...n)}}();const e=s.readFileSync(t.resolve("data","export","volunteer.json"),"utf-8"),n=JSON.parse(e),i=s.readFileSync(t.resolve("data","export","user_vol.json"),"utf-8"),r=JSON.parse(i),o=s.readFileSync(t.resolve("data","export","picture.json"),"utf-8"),a=JSON.parse(o),c=s.readFileSync(t.resolve("data","export","class_vol.json"),"utf-8"),l=JSON.parse(c),d=Y(W(n),r,a,l);s.writeFileSync(t.resolve("data","handler","activity-transformed.json"),JSON.stringify(d,null,2))}function G(e){let t,s=e[0],n=1;for(;n<e.length;){const i=e[n],r=e[n+1];if(n+=2,("optionalAccess"===i||"optionalCall"===i)&&null==s)return;"access"===i||"optionalAccess"===i?(t=s,s=r(s)):"call"!==i&&"optionalCall"!==i||(s=r(((...e)=>s.call(t,...e))),t=void 0)}return s}!async function(){console.time("export"),await c(),function(){const e=s.readFileSync(t.resolve("data","export","class.json"),"utf-8"),i=JSON.parse(e),r=[{_id:(new n.ObjectId).toString(),name:"团支书",description:"团支书是班级的团支部书记, 有权管理班级的义工, 审核班内学生创建的义工, 填报以班级为单位在校内进行的义工等.",permissions:["secretary"],type:"permission"},{_id:(new n.ObjectId).toString(),name:"实践部",description:"实践部是学校学生会的部门之一, 负责管理学生的社会实践活动, 可以创建除数据库操作有关的义工, 审核团支书创建的义工, 并且发布获奖填报和社会实践等.",permissions:["department"],type:"permission"},{_id:(new n.ObjectId).toString(),name:"审计部",description:"审计部是义管会 (目前隶属于实践部) 的部门之一, 负责审核学生义工的感想, 统计纸质义工时长, 发放义工时间.",permissions:["auditor"],type:"permission"},{_id:(new n.ObjectId).toString(),name:"监督员",description:"监督员为使用平台的管理教师, 负责查看义工平台的相关活动, 有权查看各项数据.",permissions:["inspector"],type:"permission"},{_id:(new n.ObjectId).toString(),name:"管理员",description:"管理员是平台的管理者, 有权查看平台的所有数据, 并且有权对平台进行设置. 该权限必须为开发组成员才能使用.",permissions:["admin"],type:"permission"},{_id:(new n.ObjectId).toString(),name:"系统管理员",description:"系统管理员是平台的最高管理者, 有权查看平台的所有数据, 并且有权对平台进行设置. 该权限必须为开发组成员才能使用.",permissions:["system"],type:"permission"}],o=i.filter((e=>"0"!==e.id.toString())).map((e=>({_id:(new n.ObjectId).toString(),name:p(e.name),description:e.id.toString(),permissions:["student"],type:"class"})));for(;f.length;)f.pop();f.push(...r),f.push(...o),s.writeFileSync(t.resolve("data","handler","group-transformed.json"),JSON.stringify(f,null,2),"utf-8")}(),function(){const e=s.readFileSync(t.resolve("data","export","user.json"),"utf-8"),n=JSON.parse(e),i=_(n);s.writeFileSync(t.resolve("data","handler","user-transformed.json"),JSON.stringify(i,null,2));const r=[I(n),O()].flat(1);s.writeFileSync(t.resolve("data","handler","mappings.json"),JSON.stringify(r.filter((e=>S([e,"optionalAccess",e=>e.code])&&e)),null,2)),s.writeFileSync(t.resolve("data","handler","classid-changed.json"),JSON.stringify(I(n),null,2)),s.writeFileSync(t.resolve("data","handler","class2-2023.json"),JSON.stringify(O(),null,2))}(),H(),function(){const e=s.readFileSync(t.resolve("data","handler","user-transformed.json"),"utf-8"),n=s.readFileSync(t.resolve("data","handler","mappings.json"),"utf-8"),i=function(e,t){return e.map((e=>{if(e.id>20219999){const s=t.find((t=>t._id===e._id.toString()));return s?{...e,id:s.id,password:s.id}:e}return e}))}(JSON.parse(e),JSON.parse(n)).map((e=>{e.name=e.name.replace(/[A-Za-z0-9]+/,"");const t=m(e.group),s=y.find((s=>s.name===e.name&&parseInt(g(t,(()=>"")))===s.classid));return s&&(e.id=s.id),console.log("Mapped user",e.id,"with id",e._id,"to name",e.name),e}));s.writeFileSync(t.resolve("data","handler","user-transformed-mapped.json"),JSON.stringify(i,null,2))}(),await async function(){const e=await i.readFile(t.resolve("data","handler","group-transformed.json"),"utf-8"),s=JSON.parse(e).map((e=>({...e,_id:{$oid:e._id}})));await i.writeFile(t.resolve("data","import","groups.json"),JSON.stringify(s,null,"\t")),console.log("Exported the groups in",t.resolve("data","import","groups.json"))}(),await async function(){const e=await i.readFile(t.resolve("data","handler","user-transformed-mapped.json"),"utf-8"),n=JSON.parse(e),o=JSON.parse(s.readFileSync(t.resolve("database","user_id.json")).toString()),a=n.map((async e=>{const t=await r.genSalt(),s=await r.hash(e.id.toString(),t),n=m(e.group);return{...e,password:s,_id:{$oid:e._id},id:(i=G([o,"access",e=>e.find,"call",t=>t((t=>e.id===t.id&&t.classid===n)),"optionalAccess",e=>e.id]),a=()=>e.id,null!=i?i:a())};var i,a})),c=await Promise.all(a);await i.writeFile(t.resolve("data","import","users.json"),JSON.stringify(c,null,"\t")),console.log("Exported the users in",t.resolve("data","import","users.json"))}(),await async function(){const e=await i.readFile(t.resolve("data","handler","activity-transformed.json"),"utf-8"),s=JSON.parse(e).map((e=>({...e,_id:{$oid:e._id}})));await i.writeFile(t.resolve("data","import","activities.json"),JSON.stringify(s,null,"\t")),console.log("Exported the activities in",t.resolve("data","import","activities.json")),console.log("Now you can import the data into MongoDB using `mongoimport` with the following command:"),console.log("mongoimport --db <database> --collection <collection> --file <file> --jsonArray"),console.log("Example:"),console.log("mongoimport --db test --collection users --file users.json --jsonArray")}(),console.timeEnd("export")}();
